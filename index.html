<!doctype html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>

<html>

<head>
    <title>Sync-Chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style.css">
    <!-- <link rel="stylesheet" href="style.css" type="text/css"> -->
    <!-- Favicons~~~ Desu! -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png">
    <link rel="manifest" href="/icon/site.webmanifest">
    <link rel="mask-icon" href="/icon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/icon/favicon.ico">
    <meta name="msapplication-TileColor" content="#2d89ef">
    <meta name="msapplication-config" content="/icon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <meta name="description" content="A chatroom with live text.">
    <meta name="keywords" content="Chatroom,Chat">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>

    <form action="" id="send_message">
        <input id="m" autocomplete="off" />
        <button>Send</button>
        <button id="typetoggle">Toggle</button>
    </form>
    

    <ul id="users">Users in room: </ul>
    <ul id="currenttype"></ul> 
    <ul id="messages"> </ul>

<script>

$(function() {

var roompath = window.location.pathname;
var socket = io('/',{transports: ['websocket'], upgrade: false});
socket.emit('room declare', roompath);


var is_open = 0;
var live_type = 1;

var sendform = document.getElementById("m");
var livetoggle = document.getElementById("typetoggle")

livetoggle.onclick = function(){
  sendform.value = "";
  switch(live_type){
    case 0:
      live_type = 1;
      break;
    case 1:
      live_type = 0;
      break;
    default:
  }
};
// Button press: Clears form, flips value of live_type.

function enter_detect(e){
    if (e.which == 13 || e.keyCode == 13) {
        if(document.activeElement == sendform ){
          sendform.blur();
        }
        else if(document.activeElement == document.body){
          sendform.focus();
        } 
    }
 }
// Deselects the form after send. Reselects form when pressed while unfocused.

function form_focus(e){
  if (document.activeElement == sendform){
    if (is_open == 0){
      is_open = 1;
      if (live_type == 1){
      socket.emit('open the message stop having it be closed');}
      if (live_type == 0){
      socket.emit('is typing');}
    }
  }
  else{
    if (is_open == 1 && sendform.value == ""){
    is_open = 0;
    socket.emit('close message');
    }
  }
}
// Opens a live-message if the form is focused, closes it if it's unfocused and empty.

document.body.addEventListener('keyup', enter_detect, false);
sendform.addEventListener('keyup', enter_detect, false);
sendform.addEventListener("focus", form_focus, true);
sendform.addEventListener("blur", form_focus, true);
// Adding event listeners to Enter, focus of form.
    
$('#send_message').submit(function() {
  if (live_type == 1){
    socket.emit('update message', sendform.value);
    socket.emit('message eval', sendform.value);    
    socket.emit('close message');
    is_open = 0;    
  }
  else{
    socket.emit('message eval', sendform.value, 0);
    socket.emit('close message');
    is_open = 0;
  }
  sendform.value = ''; // Clears form.
  return false;
});

$('#m').keyup(function() {
    if (is_open == 1 && live_type == 1){
      socket.emit('update message', sendform.value);
    }
    return false;
});

socket.on('server message', function(msg) {
    $('#messages').prepend($('<li>').css("color", "blue").text(msg));
});

socket.on('chat message', function(msg) {
    $('#messages').prepend($('<li>').text(msg));
});

socket.on('usercount', function(namelist) {
    // Recieves an array of names from server and updates the "Users in room" line
    var htmlusers = document.getElementById("users");
    htmlusers.innerHTML = 'Users in room: ';
    newstring = "";
    
    for (i = 0; i < namelist.length-1; i++) {
        newstring += namelist[i] + ", ";
    }
    newstring += namelist[namelist.length-1];
    
    textnode = document.createTextNode(newstring);
    htmlusers.appendChild(textnode);
});

socket.on('new message', function(name) {
    // Creates a generic message, taking in name. Should also publish message.
    if (document.getElementById("messages") !== null) {
        placement = document.getElementById("messages");

        var newMess = document.createElement("li");
        newMess.id = name;
        newMess.style.color = "#696969";
        newContent = document.createTextNode(name + ": ");
        newMess.appendChild(newContent);

        placement.insertBefore(newMess, placement.children[0]);
    }
});

socket.on('is typing', function(name){
   var status = document.createElement("li");
   status.id = name;
   newContent = document.createTextNode(name + " is typing...");
   status.appendChild(newContent);
   
   whostyping = document.getElementById("currenttype");
   whostyping.appendChild(status);
   
});

socket.on('update message', function(msg, name) {
    if (document.getElementById(name) !== null) {
        var editmess = document.getElementById(name);
        editmess.textContent = name + ": " + msg;
    }
});

socket.on('publish message', function(name) {
    var newPub = document.createElement("li");
    var clonedmessage = document.getElementById(name);
    newPub.textContent = clonedmessage.textContent;
    
    messages = document.getElementById("messages");
    messages.appendChild(newPub);
    messages.insertBefore(newPub, clonedmessage);
});

socket.on('close message', function(name) {
    if (document.getElementById(name) !== null) {
        document.getElementById(name).remove();
    }
});

});
</script>
</body>

</html>